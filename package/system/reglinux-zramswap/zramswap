#!/bin/dash

# Performance-optimized configuration
ZRAM_DEV="/dev/zram0"
ZRAM_CONF="/sys/block/zram0"
SWAP_PRIORITY=32767  # Maximum priority to use zram first

# Colors for colored output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Logging functions with colored output
log_info() {
    printf '%b[INFO]%b %s\n' "$BLUE" "$NC" "$1"
}

log_success() {
    printf '%b[OK]%b %s\n' "$GREEN" "$NC" "$1"
}

log_warning() {
    printf '%b[WARN]%b %s\n' "$YELLOW" "$NC" "$1"
}

log_error() {
    printf '%b[ERROR]%b %s\n' "$RED" "$NC" "$1" >&2
}

check_root() {
    # Ensure script is run with root privileges
    if [ "$(id -u)" -ne 0 ]; then
        log_error "This script must be run as root!"
        exit 1
    fi
}

get_optimal_compression() {
    # Get list of available compression algorithms from kernel
    available_algos=$(tr -d '[]' < "${ZRAM_CONF}/comp_algorithm" 2>/dev/null | tr ' ' '\n')

    # Try preferred algorithms in order of performance preference
    while [ $# -gt 0 ]; do
        algo=$1
        shift
        case "$available_algos" in
            *"$algo"*)
                if printf '%s\n' "$available_algos" | grep -q "^$algo$"; then
                    printf '%s\n' "$algo"
                    return 0
                fi
                ;;
        esac
    done

    # Fallback: first available algorithm
    printf '%s\n' "$available_algos" | head -n1
}

optimize_zram_params() {
    cpu_count=$(nproc)

    # ZRAM-specific performance optimizations for weak hardware
    if [ -w "${ZRAM_CONF}/max_comp_streams" ]; then
        case $cpu_count in
            1|2) streams=1 ;;
            3|4) streams=2 ;;
            *)   streams=$cpu_count ;;
        esac
        printf '%s\n' "$streams" > "${ZRAM_CONF}/max_comp_streams" 2>/dev/null
        log_info "Compression streams set to $streams (optimized for $cpu_count cores)"
    fi

    # Configure I/O scheduler for better performance with zram
    if [ -w "${ZRAM_CONF}/queue/scheduler" ]; then
        printf '%s\n' "none" > "${ZRAM_CONF}/queue/scheduler" 2>/dev/null ||
        printf '%s\n' "noop" > "${ZRAM_CONF}/queue/scheduler" 2>/dev/null
    fi

    # Reduce readahead for zram devices (optimization for SSD-like behavior)
    if [ -w "${ZRAM_CONF}/queue/read_ahead_kb" ]; then
        printf '4\n' > "${ZRAM_CONF}/queue/read_ahead_kb" 2>/dev/null
    fi
}

is_zram_active() {
    swapon --show=NAME --noheadings 2>/dev/null | grep -q "^${ZRAM_DEV}$"
}

start() {
    check_root

    if is_zram_active; then
        log_warning "ZRAM is already active!"
        status
        return 0
    fi

    log_info "Enabling performance-optimized zram..."

    # Load zram module
    if ! lsmod | grep -q "^zram "; then
        modprobe zram num_devices=1 >/dev/null 2>&1 || {
            log_error "Failed to load zram module"
            exit 1
        }
    fi

    # Wait for device to be available
    timeout=5
    while [ ! -e "$ZRAM_DEV" ] && [ $timeout -gt 0 ]; do
        sleep 1
        timeout=$((timeout - 1))
    done

    [ -e "$ZRAM_DEV" ] || {
        log_error "ZRAM device was not created"
        exit 1
    }

    services_zramswap_sizefactor="$(/usr/bin/regmsg systemconf getConfigKey services.zramswap.sizefactor)"
    case "$services_zramswap_sizefactor" in
        0.[0-9]*)
            : # valid
            ;;
        *)
            [ -n "$services_zramswap_sizefactor" ] && log_warning "'services.zramswap.sizefactor' must be a decimal < 1"
            log_info "Using default value services.zramswap.sizefactor=0.2"
            services_zramswap_sizefactor=0.2
            ;;
    esac

    services_zramswap_algorithms="$(/usr/bin/regmsg systemconf getConfigKey services.zramswap.algorithms)"
    if [ -z "$services_zramswap_algorithms" ]; then
        log_info "Using default algorithms: lz4, lzo"
        set -- lz4 lzo
    else
        set -- $services_zramswap_algorithms
    fi

    # Set optimized compression algorithm
    compression_algo=$(get_optimal_compression)
    if ! printf '%s\n' "$compression_algo" > "${ZRAM_CONF}/comp_algorithm" 2>/dev/null; then
        log_error "Failed to set compression algorithm: $compression_algo"
        exit 1
    fi
    log_info "Using compression algorithm: $compression_algo"

    # Calculate optimized size
    zram_size_kb=$(awk -v factor="$services_zramswap_sizefactor" '/MemTotal/ { printf "%.0f", $2 * factor }' /proc/meminfo)
    if ! printf '%sK\n' "$zram_size_kb" > "${ZRAM_CONF}/disksize"; then
        log_error "Failed to set zram disk size"
        exit 1
    fi

    # Apply specific optimizations
    optimize_zram_params

    # Format as swap
    mkswap -L "zram-swap" "$ZRAM_DEV" >/dev/null 2>&1 || {
        log_error "Failed to format zram device as swap"
        exit 1
    }

    # Enable swap with maximum priority
    swapon -p "$SWAP_PRIORITY" "$ZRAM_DEV" || {
        log_error "Failed to enable zram swap"
        exit 1
    }

    # Configure optimized swappiness for zram
    original_swappiness=$(cat /proc/sys/vm/swappiness)
    if [ "$original_swappiness" -lt 60 ]; then
        printf '60\n' > /proc/sys/vm/swappiness
        log_info "Swappiness adjusted to 60 (was $original_swappiness)"
    fi

    log_success "ZRAM enabled successfully!"
    log_success "Size: $((zram_size_kb / 1024)) MB using $compression_algo"
    # Show statistics
    status
}

stop() {
    check_root
    if ! is_zram_active; then
        log_warning "ZRAM is not active"
        return 0
    fi
    log_info "Disabling zram swap..."

    # Disable zram swap
    swapoff "$ZRAM_DEV" 2>/dev/null || log_warning "Failed to disable zram swap (may not be mounted)"

    # Reset zram device
    [ -w "${ZRAM_CONF}/reset" ] && printf '1\n' > "${ZRAM_CONF}/reset" 2>/dev/null

    # Remove module if not being used
    if lsmod | grep -q "^zram " && [ "$(awk '/zram/ {n++} END {print n+0}' /proc/swaps)" -eq 0 ]; then
        modprobe -r zram 2>/dev/null || true
    fi
    log_success "ZRAM swap disabled"
}

status() {
    printf '\n=== ZRAM Status ===\n'
    if ! is_zram_active; then
        printf 'Status: Inactive\n'
        return 0
    fi
    echo "Status: Active"

    # Basic information
    [ -r "${ZRAM_CONF}/disksize" ] && {
        disksize_bytes=$(cat "${ZRAM_CONF}/disksize")
        printf 'Disk size: %d MB\n' $((disksize_bytes / 1024 / 1024))
    }
    [ -r "${ZRAM_CONF}/comp_algorithm" ] && {
        algo=$(cat "${ZRAM_CONF}/comp_algorithm")
        algo=${algo#*[}
        algo=${algo%]*}
        printf 'Algorithm: %s\n' "$algo"
    }

    # Usage statistics
    if [ -r "${ZRAM_CONF}/mem_used_total" ]; then
        mem_used=$(cat "${ZRAM_CONF}/mem_used_total")
        orig_size=$(cat "${ZRAM_CONF}/orig_data_size" 2>/dev/null || echo 0)

        printf 'Memory used: %d MB\n' $((mem_used / 1024 / 1024))
        if [ "$orig_size" -gt 0 ] && [ "$mem_used" -gt 0 ]; then
            compr_ratio=$(awk "BEGIN { printf \"%.2f\", $orig_size / $mem_used }")
            printf 'Compression ratio: %s:1\n' "$compr_ratio"
            printf 'Original data: %d MB\n' $((orig_size / 1024 / 1024))
        fi
    fi

    # Show swap information
    printf '\n=== Swap Information ===\n'
    swapon --show 2>/dev/null | grep -E "(NAME|zram)" || printf 'No active swap\n'
    printf '\n'
}

case "$1" in
    start)   start ;;
    stop)    stop ;;
    restart) stop; sleep 1; start ;;
    status)  status ;;
    enabled|disabled) ;;
    *)
        printf 'Usage: %s {start|stop|restart|status}\n\n' "$0"
        printf 'Commands:\n'
        printf '  start   - Enable optimized zram swap\n'
        printf '  stop    - Disable zram swap\n'
        printf '  restart - Restart zram swap\n'
        printf '  status  - Show detailed zram information\n'
        ;;
esac
