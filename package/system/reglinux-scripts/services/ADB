#!/bin/dash

mode="$("/usr/bin/regmsg" systemconf getconfigkey system.usb.mode 2>/dev/null)"
if [ -n "${mode}" ]; then
    [ "${mode}" = "adb" ] || exit 0
else
    enabled="$("/usr/bin/regmsg" systemconf getconfigkey system.usb.adb 2>/dev/null)"
    [ "${enabled}" = "1" ] || exit 0
fi

case "$1" in
    start)
        /usr/bin/usbgadget adb
        ;;
    stop)
        /usr/bin/usbgadget stop
        ;;
    restart|reload)
        /usr/bin/usbgadget stop
        /usr/bin/usbgadget adb
        ;;
    *)
        printf '%s\n' "Usage: $0 {start|stop|restart}" >&2
        exit 1
        ;;
esac
