#!/bin/dash

BOOT_CONF="/boot/system-boot.conf"

get_key() {
    value="$("/usr/bin/regmsg" systemconf getconfigkey "$1" 2>/dev/null || true)"
    if [ -n "${value}" ]; then
        printf '%s\n' "${value}"
        return 0
    fi
    [ -r "${BOOT_CONF}" ] || return 0
    awk -F'=' -v k="$1" '
        $0 !~ /^[[:space:]]*#/ && $1 == k {print $2; exit}
    ' "${BOOT_CONF}"
}

mode="$(get_key system.usb.mode)"
if [ -n "${mode}" ]; then
    case "${mode}" in
        mtp|file_transfer) : ;;
        *) exit 0 ;;
    esac
else
    enabled="$(get_key system.usb.mtp)"
    [ "${enabled}" = "0" ] && exit 0
fi

case "$1" in
    start)
        /usr/bin/usbgadget --start
        ;;
    stop)
        /usr/bin/usbgadget stop
        ;;
    restart|reload)
        /usr/bin/usbgadget stop
        /usr/bin/usbgadget --start
        ;;
    *)
        printf '%s\n' "Usage: $0 {start|stop|restart}" >&2
        exit 1
        ;;
esac
