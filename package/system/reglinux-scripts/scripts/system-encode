#!/bin/dash

# use to hide password from people having no access to the local network
#    * based on the mac address of the ethernet card (if present)
#    * based on the cpu serial number (limited security)

getPassword() {
    serial=""
    while IFS=':' read -r key value; do
        case "$key" in
            'Serial'*)
                # Trim leading/trailing whitespace from value
                value="${value#"${value%%[![:space:]]*}"}"
                value="${value%"${value##*[![:space:]]}"}"
                serial="$value"
                break
                ;;
        esac
    done < /proc/cpuinfo

    # Get first eth* MAC address
    ethmac=""
    for f in /sys/class/net/eth*/address; do
        if [ -r "$f" ]; then
            read -r ethmac < "$f"
            break
        fi
    done

    printf '%s%s' "$serial" "$ethmac"
}

CODE="$2"

case "$1" in
    decode)
        case "$CODE" in
            enc:*)
                PASSWORD=$(getPassword)
                decrypted=$(printf '%s\n' "${CODE#enc:}" | openssl enc -aes-128-cbc -pbkdf2 -a -d -salt -pass "pass:$PASSWORD")
                { [ -n "$decrypted" ] && printf '%s\n' "$decrypted"; } || exit 1
                ;;
            *)
                printf '%s\n' "$CODE"
                ;;
        esac
        ;;
    encode)
        [ -z "$CODE" ] && exit 1
        PASSWORD=$(getPassword)
        encrypted=$(printf '%s\n' "$CODE" | openssl enc -aes-128-cbc -pbkdf2 -a -salt -pass "pass:$PASSWORD")
        { [ -n "$encrypted" ] && printf 'enc:%s\n' "$encrypted"; } || exit 1
        ;;
    *)
        printf '%s encode|decode PASSWORD\n' "$encrypted" >&2
        exit 1
        ;;
esac