#!/bin/dash

do_help() {
    printf '%s\n' \
        "Usage options for \"$0\"" \
        "(where \"myservice\" is the name of your service)" \
        "- list [all|system|user]" \
        "- enable myservice" \
        "- disable myservice" \
        "- start myservice" \
        "- stop myservice" \
        "- restart myservice" \
        "- status myservice"
}

# Service names consists only of letters, digits, and underscores, and starts with a letter or underscore.
is_valid_service_name() {
    case $1 in
        [_[:alpha:]][_[:alnum:]]*) return 0 ;;
        *)                         return 1 ;;
    esac
}

do_list() {
    system_services="$(/usr/bin/regmsg systemconf getconfigkey system.services)"
    case "$1" in
        system)
            service_folders="/usr/share/reglinux/services"
            ;;
        user)
            service_folders="/userdata/system/services"
            ;;
        *)
            service_folders="/userdata/system/services /usr/share/reglinux/services"
            ;;
    esac

    # Ignore hidden files (.*)
    find -L $service_folders -type f ! -name '.*' 2>/dev/null | sort -u |
    while IFS= read -r SERVICE; do
        SNAME=$(basename "$SERVICE")
        if ! is_valid_service_name "$SNAME"; then
            echo "WARNING: \"$SNAME\" is an invalid service script name" >&2
            continue
        fi

        # Check if enabled using pattern match
        if [ -n "$system_services" ]; then
            case " $system_services " in
                *" $SNAME "*)
                    { [ -t 1 ] && printf "%-10s %s\n" "$SNAME" "*"; } || printf "%s;%s\n" "$SNAME" "*"
                    ;;
                *)
                    { [ -t 1 ] && printf "%-10s %s\n" "$SNAME" "-"; } || printf "%s;%s\n" "$SNAME" "-"
                    ;;
            esac
        else
            { [ -t 1 ] && printf "%-10s %s\n" "$SNAME" "-"; } || printf "%s;%s\n" "$SNAME" "-"
        fi
    done
}

do_enable() {
    if ! is_valid_service_name "$1"; then
        echo "ERROR: \"$1\" is an invalid service name" >&2
        return 1
    fi

    system_services="$(/usr/bin/regmsg systemconf getconfigkey system.services)"

    # Check if already enabled
    if [ -n "$system_services" ]; then
        case " $system_services " in
            *" $1 "*)
                return 0  # already enabled
                ;;
        esac
        new_services="$system_services $1"
    else
        new_services="$1"
    fi

    /usr/bin/regmsg systemconf setconfigkey /userdata/system/system.conf system.services "$new_services"

    # Notify service in case it needs to do something when enabled
    find -L /userdata/system/services /usr/share/reglinux/services -type f -name "$1" -exec sh -c 'for f do "$f" enabled; done' sh {} + 2>/dev/null
}

do_disable() {
    system_services="$(/usr/bin/regmsg systemconf getconfigkey system.services)"
    [ -z "$system_services" ] && return 0

    # Rebuild list without the target
    new_services=""
    found=0
    for svc in $system_services; do
        if [ "$svc" = "$1" ]; then
            found=1
        else
            if [ -z "$new_services" ]; then
                new_services="$svc"
            else
                new_services="$new_services $svc"
            fi
        fi
    done

    if [ "$found" = 1 ]; then
        if [ -z "$new_services" ]; then
            /usr/bin/regmsg systemconf setconfigkey /userdata/system/system.conf system.services " "
        else
            /usr/bin/regmsg systemconf setconfigkey /userdata/system/system.conf system.services "$new_services"
        fi

        # Notify service in case it needs to do something when disabled
        find -L /userdata/system/services /usr/share/reglinux/services -type f -name "$1" -exec sh -c 'for f do "$f" disabled; done' sh {} + 2>/dev/null
    fi
}

do_start() {
    find -L /userdata/system/services /usr/share/reglinux/services -type f -name "$1" -exec sh -c 'for f do "$f" start; done' sh {} + 2>/dev/null
}

do_stop() {
    find -L /userdata/system/services /usr/share/reglinux/services -type f -name "$1" -exec sh -c 'for f do "$f" stop; done' sh {} + 2>/dev/null
}

ACTION=$1
[ -n "$1" ] && shift

case "$ACTION" in
    list)
        do_list "${1}"
        ;;
    enable)
        do_enable "${1}"
        ;;
    disable)
        do_disable "${1}"
        ;;
    start)
        do_start "$1"
        ;;
    stop)
        do_stop "$1"
        ;;
    restart)
        do_stop "$1"
        sleep 2
        do_start "$1"
        ;;
    status)
        find -L /userdata/system/services /usr/share/reglinux/services -type f -name "$1" -exec sh -c 'for f do "$f" status; done' sh {} + 2>/dev/null
        ;;
    *)
        do_help "${0}"
        exit 1
        ;;
esac