#!/bin/dash
system_services="$(/usr/bin/regmsg systemconf getConfigKey system.services)"
[ -z "$system_services" ] && { printf 'All services are disabled [ok]\n'; exit 0; }

# Service names consists only of letters, digits, and underscores, and starts with a letter or underscore.
is_valid_service_name() {
    case $1 in
        [_[:alpha:]][_[:alnum:]]*) return 0 ;;
        *)                         return 1 ;;
    esac
}

process_services() {
    service_type="$1"
    service_dir="$2"
    service_state="$3"

    # ignore hidden files (.*)
    find -L "$service_dir" -type f -not -name '.*' -print | while IFS= read -r SERVICE; do
        BASE_SERVICE=${SERVICE##*/}
        if is_valid_service_name "$BASE_SERVICE"; then
            # Check if enabled using pattern match
            case " $system_services " in
                *" $BASE_SERVICE "*)
                    if [ -x "$SERVICE" ]; then
                        "$SERVICE" "$service_state" &
                    else
                        /bin/dash "$SERVICE" "$service_state"&
                    fi
                    printf '%s Service: %s -> service is enabled [ok]\n' "$service_type" "$BASE_SERVICE"
                    ;;
                *)
                    printf '%s Service: %s -> service is disabled [ok]\n' "$service_type" "$BASE_SERVICE"
                    ;;
            esac
        else
            # Suggest name: remove invalid chars, strip leading digits
            # Step 1: Remove all invalid characters
            temp=$(printf '%s' "$BASE_SERVICE" | tr -cd '_[:alnum:]')
            # Step 2: Remove leading digits (loop until no leading digit)
            while case $temp in [0-9]*) true;; *) false;; esac; do
                temp=${temp#?}
            done
            BASE_SERVICE_SUGGEST=${temp:-custom_service}
            printf '%s Service: %s [failed] -> invalid service name, suggest rename service file to: "%s"\n' "$service_type" "$BASE_SERVICE" "$BASE_SERVICE_SUGGEST"
        fi
    done
}

process_services User /userdata/system/services "$1"
process_services System /usr/share/reglinux/services "$1"
[ "$1" = "stop" ] && wait    # wait for spawned scripts to finish on stop condition