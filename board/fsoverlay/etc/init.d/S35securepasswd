#!/bin/dash
case "$1" in
    start|restart)
        printf "Starting %s: " "$0"
        if [ "$(/usr/bin/regmsg getConfigKey system.security.enabled)" = "0" ]; then
            MASTERPASSWD="linux";
            ksmbd.adduser -C /etc/ksmbd/ksmbd.conf -P /etc/ksmbd/ksmbdpwd.db -p "$MASTERPASSWD" root >/dev/null
        else
            MASTERPASSWD=$(/usr/bin/system-config getRootPassword 1)
            ksmbd.adduser -C /etc/ksmbd/ksmbd-secure.conf -P /etc/ksmbd/ksmbdpwd.db -p "$MASTERPASSWD" root >/dev/null
        fi

        # /etc/shadow is dynamically generated from the password found in /boot/system-boot.conf
        # the password is visible only in the ES interface
        # or to people having already a ssh password via the command 'system-config setRootPassword xyz'
        SHADOWPASSWD=$(openssl passwd -1 "$MASTERPASSWD")
        {
            printf 'root:%s:::::::\n' "$SHADOWPASSWD"
            printf 'reglinux::::::::\n'                   # required for su for flatpak/reglinux user
        } > /run/reglinux.shadow

        echo "done."
        ;;
    *) exit 0 ;;
esac