#!/bin/dash
case "$1" in
    start)
        { [ "$(/usr/bin/regmsg systemconf getconfigkey controllers.ps3.enabled)" = "1" ] && [ "$(/usr/bin/regmsg systemconf getconfigkey controllers.bluetooth.enabled)" = "1" ]; } || exit 0
        [ "$(/usr/bin/regmsg systemconf getconfigkey controllers.ps3.driver)" = "bluez" ] && exit 0    # Exit early if bluez â€” no action needed
        : "${controllers_ps3_driver:=official}"                                             # Default to "official" if empty
        exec "/usr/sixad/$controllers_ps3_driver/sixad-bin" 0 0 0 >/dev/null 2>&1 &
        ;;
    stop)
        pkill -f sixad-bin >/dev/null 2>&1
        pkill -f sixad-sixaxis >/dev/null 2>&1
        ;;
    restart|reload)
        # Call functions directly instead of forking new shell processes
        set -- stop
        . "$0"
        set -- start
        . "$0"
        ;;
    *)
        printf '%s\n' "Usage: $0 {start|stop|restart}" >&2
        exit 1
        ;;
esac