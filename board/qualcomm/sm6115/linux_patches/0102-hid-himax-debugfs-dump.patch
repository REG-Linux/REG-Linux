From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: Downstream Import <noreply@example.com>
Date: Thu, 1 Jan 1970 00:00:00 +0000
Subject: [PATCH] hid: himax: expose flash dump via debugfs early

Create the debugfs flash blob before reading so partial dumps are
available even if the flash read or HID table parse fails.

---
 drivers/hid/hid-himax.c | 16 ++++++++++++++++
 1 file changed, 16 insertions(+)

diff --git a/drivers/hid/hid-himax.c b/drivers/hid/hid-himax.c
index f8a417e07f0c..c2b0c06d5e90 100644
--- a/drivers/hid/hid-himax.c
+++ b/drivers/hid/hid-himax.c
@@ -7,6 +7,10 @@
 
 #include "hid-himax.h"
 
+#include <linux/debugfs.h>
+
+static struct dentry *himax_debugfs_dir;
+static struct debugfs_blob_wrapper himax_fw_blob;
+
 static int himax_chip_init(struct himax_ts_data *ts);
 static void himax_ts_work(struct himax_ts_data *ts);
 
@@ -1430,6 +1434,18 @@ static int himax_load_config(struct himax_ts_data *ts)
        ts->himax_fw_data = devm_kzalloc(ts->dev, HIMAX_HX83102J_FLASH_SIZE, GFP_KERNEL);
        if (!ts->himax_fw_data)
                return -ENOMEM;
+
+       if (!himax_debugfs_dir)
+               himax_debugfs_dir = debugfs_create_dir("himax", NULL);
+       if (himax_debugfs_dir) {
+               himax_fw_blob.data = ts->himax_fw_data;
+               himax_fw_blob.size = HIMAX_HX83102J_FLASH_SIZE;
+               debugfs_create_blob("flash.bin", 0444,
+                                   himax_debugfs_dir,
+                                   &himax_fw_blob);
+       }
+
+       return 0;
 }
